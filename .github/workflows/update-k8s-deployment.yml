name: Update Kubernetes Deployment

on:
  repository_dispatch:
    types: [laravel-docker-updated]
  workflow_dispatch:
    inputs:
      ecr_image_uri:
        description: 'Full ECR image URI (e.g., 123456.dkr.ecr.ap-southeast-2.amazonaws.com/laravel-app-k8s:20251116-143022-abc123)'
        required: true
        type: string

env:
  AWS_REGION: ap-southeast-2

permissions:
  contents: write

jobs:
  update-deployment:
    name: Update Deployment Manifests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GitOps Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          fetch-depth: 0

      - name: Extract Image URI
        id: image
        run: |
          if [ -n "${{ github.event.inputs.ecr_image_uri }}" ]; then
            # Manual trigger
            IMAGE="${{ github.event.inputs.ecr_image_uri }}"
          else
            # Webhook trigger from laravel-docker
            IMAGE="${{ github.event.client_payload.image }}"
          fi
          
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Using image: ${IMAGE}"

          
      - name: Update Laravel Deployment YAML
        env:
          IMAGE_URI: ${{ steps.image.outputs.image }}
        run: |
          echo "ðŸ”„ Updating laravel-deployment.yaml..."
          # Update only the laravel container image, not nginx
          sed -i "/- name: laravel/,/- name: nginx/ s|image:.*|image: ${IMAGE_URI}|" base/laravel/laravel-deployment.yaml
          
          echo "âœ… Updated laravel-deployment.yaml"
          grep "image:" base/laravel/laravel-deployment.yaml

      - name: Update Laravel Worker Deployment YAML
        env:
          IMAGE_URI: ${{ steps.image.outputs.image }}
        run: |
          echo "ðŸ”„ Updating laravel-worker.yaml..."
          sed -i "s|image:.*|image: ${IMAGE_URI}|g" base/laravel/laravel-worker.yaml
          
          echo "âœ… Updated laravel-worker.yaml"
          grep "image:" base/laravel/laravel-worker.yaml

      - name: Commit and Push Changes
        env:
          IMAGE_URI: ${{ steps.image.outputs.image }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add base/laravel/laravel-deployment.yaml
          git add base/laravel/laravel-worker.yaml
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            git commit -m "chore: Update Laravel image to ${IMAGE_URI}"
            git push
            echo "âœ… Changes pushed to Git"
          fi

      - name: Deployment Summary
        env:
          IMAGE_URI: ${{ steps.image.outputs.image }}
        run: |
          echo "## ðŸš€ Deployment Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New Image**: \`${IMAGE_URI}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployment manifests updated in Git" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ ArgoCD will automatically sync changes" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ New pods will be deployed to EKS cluster" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Monitor deployment: \`kubectl get pods -n laravel-app -w\`" >> $GITHUB_STEP_SUMMARY